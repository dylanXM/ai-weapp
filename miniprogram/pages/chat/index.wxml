<van-nav-bar border="{{false}}" custom-class="p-navbar-container">
  <van-icon
    name="wap-nav"
    bind:click="showPopup"
    color="#4d4d4d"
    slot="left"
    size="24"
  />
  <view slot="title" data-group="{{currentGroup}}" bind:tap="showGroupOperate" wx:if="{{ currentApp.id }}" class="p-navbar-title">
    <view>{{currentApp.name}}</view>
    <van-icon
      name="arrow"
      color="#aaaaaa"
      slot="left"
      size="16"
    />
  </view>
  <view slot="title" wx:if="{{ !currentApp.id }}" bind:tap="showModelActionSheet" data-group="{{currentGroup}}" class="p-navbar-title">
    <view>{{model.modelName}}</view>
    <van-icon
      name="arrow"
      color="#aaaaaa"
      slot="left"
      size="16"
    />
  </view>
</van-nav-bar>

<view
  style="height: calc(100vh - {{navBar.navBarHeight + (keyboardHeight > 0 ? keyboardHeight : 0)}}px);"
  class="p-container"
>
  <view
    class="p-chat-container"
    wx:if="{{groups.length !== 0}}"
    style="height: calc(100% - {{navBar.navBarHeight + (keyboardHeight > 0 ? keyboardHeight : bottomSafeHeight + 50)}}px);"
  >
    <!-- 聊天记录区 -->
    <scroll-view
      scroll-y
      class="p-chat-messages"
      scroll-with-animation="{{ !loading }}"
      enable-passive
      id="messages-view"
      wx:if="{{messageMap[currentGroup.id].length !== 0}}"
      scroll-into-view="{{toView}}"
      lower-threshold="120"
      bindscroll="onScroll"
      refresher-default-style="none"
    >
      <view
        wx:for="{{messageMap[currentGroup.id]}}"
        wx:key="chatId"
        wx:for-item="message"
        wx:for-index="idx"
      >
        <!-- 用户信息 -->
        <view style="padding-top: {{ idx === 0 ? 18 : 0 }}px;" class="p-chat-message-contianer" wx:if="{{message.inversion}}">
          <view class="p-chat-message-title">
            <image class="p-chat-message-avatar" src="{{user.userInfo.avatar}}" />
            <view class="p-chat-message-title-name">您</view>
          </view>
          <view class="p-chat-message-container">{{message.text}}</view>
        </view>

        <view class="p-chat-message-robot-contianer" wx:if="{{!message.inversion}}">
          <view class="p-chat-message-title">
            <image class="p-chat-message-avatar" src="{{currentApp.coverImg || appImg}}" />
            <view class="p-chat-message-title-name">{{ currentApp.name || 'sweetAI'}}</view>
          </view>
          <view class="p-chat-message-robot">
            <towxml nodes="{{message.text}}" />
            <view wx:if="{{message.loading && !message.text}}" class="p-chat-message-loading" />
          </view>
          <view wx:if="{{!message.loading && !message.error}}" class="p-chat-robot-operate" >
            <van-button
              custom-class="p-common-no-border"
              icon="label-o"
              type="default"
              size="small"
              data-text="{{message.originText}}"
              bind:click="copyGptResult"
            >
              复制
            </van-button>
            <van-button
              custom-class="p-common-no-border"
              icon="replay"
              type="default"
              size="small"
              data-text="{{message.requestOptions.prompt}}"
              bind:click="clickPrompt"
            >
              重新回答
            </van-button>
          </view>
        </view>
      </view>
      <view id="id_bottom_container" style="width: 100%; height: {{ loading ? 40 : 12 }}px"></view>
    </scroll-view>
    <view wx:if="{{messageMap[currentGroup.id].length === 0}}" class="p-chat-nomessage-container">
      <view class="p-chat-nomessage-desc">
        <image class="p-chat-empty-avatar" src="{{currentApp.coverImg || appImg}}" />
        <view class="p-chat-empty-desc">今天有什么可以帮您？</view>
      </view>
      <view class="p-chat-nomessage-demo">
        <view wx:if="{{currentApp.id}}" class="p-chat-nomessage-demo-list">
          <view
            wx:for="{{ currentApp.appDemo }}"
            bind:tap="clickPrompt"
            wx:key="item"
            wx:for-item="item"
            size="small"
            round
            type="default"
            data-text="{{item}}"
            class="p-chat-nomessage-demo-item"
          >
            {{item}}
          </view>
        </view>
      </view>
    </view>
    <!-- 搜索区 -->
    <view class="p-chat-search">
      <van-icon
        name="down"
        size="16"
        class="p-chat-message-to-bottom"
        bindtap="scrollToBottom"
        color="#4d4d4d"
        wx:if="{{ !isScrollToLower && messageMap[currentGroup.id].length && !loading }}"
      />
      <view class="p-chat-search-border">
        <van-field
          placeholder="请输入你的问题或需求"
          border="{{ false }}"
          custom-style="padding: 0px;"
          value="{{ value }}"
          class="p-chat-search-input"
          adjust-position="{{false}}"
          bind:change="handleValueChange"
          confirm-type="send"
          confirm-hold="{{true}}"
          bind:confirm="chatProcess"
          disabled="{{ loading }}"
          bind:keyboardheightchange="handlekeyboardHeightChange"
          autosize
          type="textarea"
          size="large"
        />
      </view>
      <van-icon
        wx:if="{{!loading}}"
        name="upgrade"
        size="34"
        bind:click="chatProcess"
        color="#4d4d4d"
        class="p-chat-search-icon"
      />
      <van-icon
        wx:if="{{loading}}"
        name="stop-circle-o"
        size="34"
        color="red"
        bind:click="cancelChatProcess"
        class="p-chat-icon-cancel p-chat-search-icon"
      />
    </view>
  </view>

  <view class="p-chat-container" wx:if="{{groups.length === 0}}">
    <empty style="height: 100%" bind:createChatGroup="createChatGroup" />
  </view>

  <view style="height: {{keyboardHeight > 0 ? 0 : bottomSafeHeight}}px"></view>
</view>

<van-popup
  position="left"
  show="{{ popupVisible }}"
  bind:close="closePopup"
  custom-class="p-chat-sidesheet"
  custom-style="width: 75%;"
>
  <view class="p-chat-group-container">
    <view style="padding-top: {{navBar.menuTop - 8}}px;" class="p-chat-group-search">
      <van-cell border="{{ false }}" bind:tap="handleClickSetting">
        <view slot="title" class="p-chat-user-info">
          <van-image
            width="26px"
            height="26px"
            fit="cover"
            radius="4"
            src="{{user.userInfo.avatar}}"
            custom-class="p-chat-user-avatar"
          />
          <view>{{user.userInfo.username}}</view>
        </view>
        <van-icon slot="right-icon" name="add-o" catchtap="createChatGroup" class="custom-icon" size="26" />
      </van-cell>
    </view>
    <view class="p-chat-group-list p-common-blur">
      <van-cell-group title="操作" inset border>
        <!-- <van-cell
          title="新建预设"
          icon="coupon-o"
          is-link
          bind:tap="createChatGroup"
        /> -->
        <van-cell
          title="预设模版"
          icon="bill-o"
          is-link
          data-key="presets"
          bind:tap="handleClickExplore"
        />
      </van-cell-group>
      <van-cell-group wx:if="{{ groups.length }}" title="对话历史" inset border>
        <van-cell
          custom-style="background: {{group.id === currentGroup.id ? '#f1f1f1' : 'white'}};"
          title="{{group.title}}"
          bind:click="chooseGroup"
          data-text="{{group.id}}"
          icon="chat-o"
          title-class="p-common-ellipsis"
          data-group="{{group}}"
          bind:longpress="showGroupOperate"
          wx:for="{{groups}}"
          wx:key="id"
          wx:for-item="group"
        />
      </van-cell-group>
    </view>
    <view style="height: {{keyboardHeight > 0 ? 0 : bottomSafeHeight}}px" class="p-common-blur"></view>
  </view>
</van-popup>

<van-action-sheet
  title="选择模型"
  show="{{ modelConfig.visible }}"
  actions="{{ modelConfig.options }}"
  bind:close="closeModelActionSheet"
  bind:select="onSelectModel"
  cancel-text="取消"
  bind:cancel="closeModelActionSheet"
/>

<van-action-sheet
  show="{{ groupOperate.visible }}"
  actions="{{ groupOperate.actions }}"
  bind:close="closeGroupOperate"
  bind:select="operateChatGroup"
  cancel-text="取消"
  bind:cancel="closeGroupOperate"
/>

<van-dialog
  use-slot
  title="修改对话组名称"
  show="{{ groupOperate.renameVisible }}"
  show-cancel-button
  bind:confirm="confirmRenameGroup"
>
  <van-field
    value="{{ groupOperate.newName }}"
    placeholder="请输入新的对话组名称"
    title="修改对话组名称"
    bind:change="groupNewNameChange"
    type="textarea"
    border="{{ false }}"
    size="large"
  />
</van-dialog>

<van-action-sheet bind:close="closeSetting" custom-class="p-common-bg" show="{{ settings.visible }}" title="Settings">
  <view style="height: calc(100vh - {{navBar.navBarHeight + 80}}px)">
    <van-cell-group title="积分" inset>
      <van-cell title="普通模型积分" value="{{user.userBalance.model3Count}}" />
      <van-cell title="高级模型积分" value="{{user.userBalance.model4Count}}" />
    </van-cell-group>

    <van-cell-group title="积分获取" inset>
      <van-cell title="签到获取积分" is-link bind:tap="handleClickSignIn" />
      <van-cell title="积分兑换" is-link bind:tap="handleClickKaimi" />
    </van-cell-group>

    <van-cell-group title="联系我们" inset>
      <van-cell title="公众号" is-link bind:tap="handleClickWXofficial" />
      <van-cell title="管理员" is-link bind:tap="handleClickWXAdmin" />
    </van-cell-group>

    <!-- <van-cell-group title="我的预设模版" inset>
      <van-cell title="公众号" is-link bind:tap="handleClickWXofficial" />
      <van-cell title="管理员" is-link bind:tap="handleClickWXAdmin" />
    </van-cell-group> -->
  
  </view>
</van-action-sheet>
