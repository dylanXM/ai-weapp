<t-navbar bordered="{{false}}" t-class="p-navbar-container" animation>
  <t-icon color="#4d4d4d" slot="left" name="view-list" size="24" bind:click="togglePopup" />
  <view slot="title" data-group="{{currentGroup}}" bind:tap="showGroupOperate" wx:if="{{ currentApp.id }}" class="p-navbar-title">
    <view>{{currentApp.name}}</view>
    <t-icon color="#aaaaaa" name="chevron-right" size="20" />
  </view>
  <view slot="title" wx:if="{{ !currentApp.id }}" bind:tap="showModelActionSheet" data-group="{{currentGroup}}" class="p-navbar-title">
    <view>{{model.modelName}}</view>
    <t-icon color="#aaaaaa" name="chevron-right" size="20" />
  </view>
</t-navbar>

<view
  style="height: calc(100vh - {{navBar.navBarHeight + (keyboardHeight > 0 ? keyboardHeight : bottomSafeHeight + 60)}}px);"
  class="p-container"
>
  <view
    class="p-chat-container"
    wx:if="{{groups.length !== 0}}"
    style="height: calc(100% - {{navBar.navBarHeight + (keyboardHeight > 0 ? keyboardHeight : bottomSafeHeight + 60)}}px);"
  >
    <!-- 聊天记录区 -->
    <scroll-view
      scroll-y
      class="p-chat-messages"
      scroll-with-animation
      enable-passive
      id="messages-view"
      wx:if="{{messageMap[currentGroup.id].length !== 0}}"
      scroll-into-view="{{toView}}"
      lower-threshold="120"
      bindscroll="onScroll"
      refresher-default-style="none"
    >
      <view
        wx:for="{{messageMap[currentGroup.id]}}"
        wx:key="chatId"
        wx:for-item="message"
        wx:for-index="idx"
      >
        <!-- 用户信息 -->
        <view style="padding-top: {{ idx === 0 ? 18 : 0 }}px;" class="p-chat-message-contianer" wx:if="{{message.inversion}}">
          <view class="p-chat-message-title">
            <image class="p-chat-message-avatar" src="{{user.userInfo.avatar}}" />
            <view class="p-chat-message-title-name">您</view>
          </view>
          <view class="p-chat-message-container">{{message.text}}</view>
        </view>

        <view class="p-chat-message-robot-contianer" wx:if="{{!message.inversion}}">
          <view class="p-chat-message-title">
            <image class="p-chat-message-avatar" src="{{currentApp.coverImg || appImg}}" />
            <view class="p-chat-message-title-name">{{ currentApp.name || 'sweetAI'}}</view>
          </view>
          <view class="p-chat-message-robot">
            <towxml nodes="{{message.text}}" />
            <view wx:if="{{message.loading}}" class="p-chat-message-loading" />
          </view>
          <view wx:if="{{!message.loading && !message.error}}" class="p-chat-robot-operate" >
            <t-button data-text="{{message.originText}}" bind:tap="copyGptResult" variant="text" t-class="p-common-no-border" icon="copy" content="复制" size="small"></t-button>
            <t-button data-text="{{message.requestOptions.prompt}}" bind:tap="clickPrompt" variant="text" t-class="p-common-no-border" icon="refresh" content="重新回答" size="small"></t-button>
          </view>
        </view>
      </view>
      <view id="id_bottom_container" style="width: 100%; height: {{ loading ? 40 : 12 }}px"></view>
    </scroll-view>
    <view wx:if="{{messageMap[currentGroup.id].length === 0}}" class="p-chat-nomessage-container">
      <view class="p-chat-nomessage-desc">
        <image class="p-chat-empty-avatar" src="{{currentApp.coverImg || appImg}}" />
        <view class="p-chat-empty-desc">今天有什么可以帮您？</view>
      </view>
      <view class="p-chat-nomessage-demo">
        <view wx:if="{{currentApp.id}}" class="p-chat-nomessage-demo-list">
          <view
            wx:for="{{ currentApp.appDemo }}"
            bind:tap="clickPrompt"
            wx:key="item"
            wx:for-item="item"
            size="small"
            round
            type="default"
            data-text="{{item}}"
            class="p-chat-nomessage-demo-item"
          >
            {{item}}
          </view>
        </view>
      </view>
    </view>
    <!-- 搜索区 -->
    <view class="p-chat-search">
      <t-icon
        color="#4d4d4d"
        name="arrow-down"
        size="20"
        wx:if="{{ !isScrollToLower && messageMap[currentGroup.id].length && !loading }}"
        t-class="p-chat-message-to-bottom"
        bindtap="scrollToBottom"
      />
      <view class="p-chat-search-border">
        <t-textarea
          bind:change="handleValueChange"
          value="{{ value }}"
          t-class="p-chat-search-input"
          placeholder="请输入你的问题或需求"
          disableDefaultPadding="{{true}}"
          adjust-position="{{false}}"
          autosize
          placeholderStyle="font-size: 22px;"
          bind:keyboardheightchange="handlekeyboardHeightChange"
        />
        <t-icon
          name="explore"
          wx:if="{{!loading}}"
          size="34"
          bind:click="chatProcess"
          color="#4d4d4d"
          class="p-chat-search-icon"
        />
        <t-icon
          name="stop-circle"
          wx:if="{{loading}}"
          size="34"
          bind:click="chatProcess"
          color="red"
          class="p-chat-icon-cancel p-chat-search-icon"
        />
      </view>
    </view>
  </view>

  <view class="p-chat-container" wx:if="{{groups.length === 0}}">
    <empty style="height: 100%" bind:createChatGroup="createChatGroup" />
  </view>

  <t-popup
    placement="left"
    visible="{{ popupVisible }}"
    bind:close="closePopup"
    t-class-content="p-chat-sidesheet"
    bind:visible-change="onPopupVisibleChange"
    overlay-props="{{ popupOverlay }}"
    zIndex="{{ 10500 }}"
  >
    <view class="p-chat-group-container" style="padding-bottom: {{bottomSafeHeight}}px;">
      <view style="padding-top: {{navBar.menuTop - 6}}px;" class="p-chat-group-search">
        <!-- <van-search placeholder="请输入搜索关键词" bind:change="searchChatGroup" /> -->
        <t-search placeholder="请输入搜索关键词" bind:change="searchChatGroup" />
      </view>
      <view class="p-chat-group-list">
        <view wx:for="{{groups}}" wx:key="id" wx:for-item="group">
          <t-cell
            style="background: {{group.id === currentGroup.id ? '#f1f1f1' : 'unset'}}; padding: 10px 12px;"
            bordered="{{false}}"
            title="{{group.title}}"
            bind:click="chooseGroup"
            data-text="{{group.id}}"
            t-class-title="p-common-ellipsis"
            data-group="{{group}}"
            bindlongpress="showGroupOperate"
          >
          </t-cell>
        </view>
      </view>
      <view class="p-chat-group-user p-common-blur">
        <t-cell
          t-class="p-common-blur p-common-cell-padding"
          title="{{userBalance.modelType === 1 ? '普通' : '高级'}}额度"
          icon="coupon-o"
          bordered="{{ false }}"
          note="{{userBalance.modelCount}} 积分"
        />
        <t-cell
          t-class="p-common-blur p-common-cell-padding"
          title="模型费用"
          icon="bill-o"
          bordered="{{ false }}"
          note="{{userBalance.modelPrice}} 积分 / 对话"
        />
      </view>
      <view class="p-chat-group-add">
        <t-button theme="primary" block icon="add" bind:tap="createChatGroup" content="新建对话"></t-button>
      </view>
    </view>
  </t-popup>
</view>

<t-action-sheet data-type="overlay" show-overlay id="choose-model-action-sheet" bind:selected="onSelectModel" />

<t-action-sheet data-type="overlay" show-overlay id="group-operate-action-sheet" bind:selected="operateChatGroup" />

<t-dialog
  visible="{{groupOperate.renameVisible}}"
  title="修改对话组名称"
  confirm-btn="确定"
  cancel-btn="取消"
  bind:confirm="confirmRenameGroup"
  bind:close="closeRenameGroup"
  show-overlay
>
  <t-input
    value="{{ groupOperate.newName }}"
    borderless
    clearable
    slot="content"
    placeholder="请输入新的对话组名称"
    placeholder-class="placeholder"
    bind:change="groupNewNameChange"
  />
</t-dialog>